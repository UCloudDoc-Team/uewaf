# 回源与监控设置

UWAF 始终以客户业务为先，优先保障域名的正常业务，为此提供了便捷的回源设置以及多种类型的监控。在业务经过 UWAF 出现异常时可以快速将解析改为源站。各种监控因不同域名的业务需求不同，需要结合实际的业务场景在[监控设置](#监控设置)中独立设置域名各种监控告警。

!> 注意：  
监控设置，除业务异常自动回源外，其他监控类型均受[全局告警设置](/uewaf/global/message/alert)中的开关控制，这里仅为域名级别的子开关，如果未开启全局告警设置的对应开关，则会无法收到短信或者邮件告警通知。

## 回源设置

可以点击域名后方的**【更多】**按钮，改变 CNAME 防护域名 的解析。

### 业务回源

修改当前 UWAF 的 CNAME 防护域名 DNS 解析，将 CNAME 防护域名 的解析改为域名源站，若源站为域名，则解析到域名最终解析得到的 IP 地址上，若域名存在多个源站，默认解析到第一个源站。

![](/images/monitor_set-set_back.png)

### 解除回源

修改当前 UWAF 的 CNAME 防护域名 DNS 解析，将 CNAME 防护域名 的解析改为 UWAF 的 防护 IP 。

## 监控设置

此处的监控设置为域名级别的告警信息的接收与关闭。除业务异常自动回源设置外，均受全局告警设置开关控制，如果未开启全局告警设置的对应开关，则会无法收到短信或者邮件告警通知。

![](/images/monitor_set-get_settings.png)

以下开关均是开启或关闭**域名级别**的告警或监控。

### 攻击告警监控

UWAF 监控域名的攻击态势，默认为 1 分钟之内，单 IP 触发同一攻击类型超过 500 次，则会向对应的消息订阅组用户发送告警邮件或者短信。

### 异常状态码监控

UWAF 监控域名业务的状态码，业务 QPS 平均值需要大于 10 以上，低于 10 则不会触发告警。如整体请求中 499 以上响应码比例大于 30%，则会向对应的消息订阅组用户发送告警邮件或者短信。频率为 5 分钟一次。

### 源站状态监控

UWAF 默认会对添加的域名使用 HEAD 请求方法进行探测访问，探测路径为：`探测客户端 -> UWAF -> 源站` 或 `探测客户端 -> 源站`，HTTP 与 HTTPS 业务可用性表示的是前者的链路状态。请注意源站或域名是否具有安全策略，如有，请将 UWAF 监控 IP（回源 IP）需加入白名单。如果 5 分钟内，连续 3 次请求都是异常响应，则会向对应的消息订阅组用户发送告警邮件或者短信。频率为 5 分钟一次。

?> 说明：  
此功能关闭后，只是不再发送告警邮件或者短信，UWAF 探测客户端还是会继续探测源站。  
UWAF 探测客户端会随机选择回源 IP 网段中地址作为源 IP 进行探测（极少情况下会使用域名 防护 IP 为源 IP）。若源站或域名有安全策略，需要源站放行 UWAF 的回源 IP 的 HEAD 请求，同时在 UWAF 控制台将回源 IP 添加到域名的白名单中。

同时用户可以自定义探测的请求路径，若在监控地址填写了完整的 URL，探测请求会将访问该 URL 的响应作为判断源站状态的依据。

### 配置示例

当我们自定义设置一个源站状态监控地址后，
![](/images/monitor_set-set_monitor_url.png)

等待几分钟后，源站服务器收到的探测请求应当为自定义设置的文件路径。日志如下：
![](/images/monitor_set-get_monitor_log.png)

### 业务异常自动回源设置

开启业务异常自动回源设置后，UWAF 会对该域名的业务做可用性监控，请注意源站或域名是否具有安全策略，如有，请将 UWAF 监控 IP（回源 IP）需加入白名单，如连续 10 次，源站探测请求的响应码均大于 499 且业务的 QPS 大于 50，则会把该域名的 DNS 解析地址指向该域名的源站（多源站情况下，默认为第一个源站），此功能探测监控原理同[源站状态监控](#源站状态监控)，若自定义了监控地址，则会对该 URL 进行探测。同时也可以手动对域名的解析进行[业务回源](#业务回源)或者[解除回源](#解除回源)。
