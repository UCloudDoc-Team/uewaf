# UWAF 规则

UWAF本身包含多种类型（协议违规、注入攻击、跨站脚本、漏洞攻击、命令执行等）的默认防护规则，除了这些类型中已有的规则，您还可以自定义添加防护规则已实现对攻击的精准拦截和放行某些请求。

## 规则列表

规则有不同的优先级，默认规则处于最低优先级，无法进行调整。自定义规则的优先级可以调整，位于规则列表最上面的规则具有最高优先级，下方的规则优先级依次降低。

- 可以上调或降低规则的优先级，列表上面的规则优先级高于下面的规则；
- 优先级高的规则如果与优先级低的规则冲突，则以优先级高的为准；
- 系统的默认规则优先级是最低的，且无法进行调整。

![uwaf_rule_2.png](/images/uwaf_rule_2.png)

## 添加规则

规则由规则名称、匹配动作、风险等级、风险类型、匹配条件组成。阻断模式和告警模式下，若规则的匹配动作为拦截，请求命中某条自定义规则则会记录一条攻击日志，日志详情可以在[攻击详情](/uewaf/features/report/Attack_details)中查看；若规则的匹配动作为放行，请求命中此规则的话不会产生攻击日志。**告警模式下拦截请求仅会记录攻击日志，但不会拦截请求**。

![uwaf_rule_1.png](/images/uwaf_rule_1.png)

### 规则参数说明：
|参数|说明|
|-|-|
|规则名称|自定义规则的名称，可以为任意中英文字符|
|匹配动作|拦截或者放行。拦截会记录攻击日志，放行不会记录攻击日志|
|风险等级|高风险、中风险或者低风险，用于标识规则的风险级别|
|风险类型|标识规则的类型，可选值：恶意扫描、协议畸形、越权访问、信息泄漏、WebShell、漏洞攻击、跨站脚本、CC攻击、注入攻击、命令执行、其他攻击|
|匹配条件|由匹配字段、逻辑符、匹配内容和参数解码组成，多个条件之间的逻辑为且，即条件都满足时，才能命中规则。详情见[匹配条件说明](/uewaf/features/rule/UWAF_rule?id=匹配条件说明)|

### 匹配条件说明

匹配字段说明及其与逻辑符的对应关系如下：

|匹配字段|说明|逻辑符|
|-|-|-|
|来源IP|请求客户端的源IP，若开启了「WAF前是否具有代理」，则取指定字段的IP作为源IP|属于、不属于（CIDR格式）；等于、不等于|
|Referer|在不同网页跳转时，会附带源页面的链接地址，告诉服务器是从哪个页面链接过来的|包含、不包含；等于、不等于；长度大于、小于；不存在；正则；多行、非多行匹配|
|请求UA|用于标识请求客户端的字符串，即HTTP请求的User-Agent字段|包含、不包含；等于、不等于；长度大于、小于；正则；多行、非多行匹配|
|请求路径|客户端提交请求路以访问服务端的指定资源，例如首页的请求路径为 `/` |包含、不包含；等于、不等于；长度大于、小于；正则；多行、非多行匹配|
|请求方法|请求的方法，如 `GET`, `POST`|包含、不包含；等于、不等于；长度大于、小于；正则；多行、非多行匹配|
|请求内容|请求的Body部分的内容|包含、不包含；等于、不等于；长度大于、小于；正则；多行、非多行匹配|
|URL查询参数*|URL中的参数，例如 `?a=1&b=2` ，则URL查询参数为 `a, b` ，参数值为 `1, 2`|包含、不包含；等于、不等于；长度大于、小于；不存在；正则；多行、非多行匹配|
|请求Cookie*|客户端请求的Cookie，Cookie用于记录某些网页配置或向服务器标识身份|包含、不包含；等于、不等于；长度大于、小于；不存在；正则；多行、非多行匹配|
|请求参数*|包含URL、Cookie和Body中的参数|包含、不包含；等于、不等于；长度大于、小于；不存在；正则；多行、非多行匹配|
|自定义请求头*|客户端请求中除Referer、User-Agent、Cookie外的其他字段，也可以是自定义的字段|包含、不包含；等于、不等于；长度大于、小于；不存在；正则；多行、非多行匹配|

带 * 的匹配字段标识其为键值结构，这些字段的匹配内容可以接收一个 JSON 字符串以针对单个键的值、键名、值名或全部键、值名进行匹配。**若输入普通字符串或不符合JSON格式的字符串，则默认对全部键名、值进行匹配**。

|匹配内容类型|示例用法|说明|
|-|-|-|
|特定键的值|``{"pattern": "string", "specific": "specific-key"}``|匹配键值结构中的某一特定键 `specific-key` 的值。例如：自定义请求头，则检测请求中的 `specific-key` 字段的值是否匹配 `string` ；URL查询参数，若其为 `?specific-key=xxx` ，则检测 `xxx` 是否匹配 `string`|
|全部键名|``{"pattern": "string", "keys": true}``|遍历匹配键值结构的全部键名。例如：URL查询参数，若其为 `?a=1&b=2` ，会分别检测 `a` 和 `b` 是否匹配 `string`|
|全部值|``{"pattern": "string", "values": true}``|遍历匹配键值结构的全部值。例如：URL查询参数，若其为 `?a=1&b=2` ，会分别检测 `1` 和 `2` 是否匹配 `string`|
|全部键名、值|``{"pattern": "string", "all": true}``|遍历匹配键值结构的全部值名和值。例如：URL查询参数，若其为 `?a=1&b=2` ，会分别检测 `a`, `b`, `1` 和 `2` 是否匹配 `string`|
|全部键名、值|``string``|会被当成 ``{"pattern": "string", "all": true}`` 解析|

### 参数解码说明

可对匹配内容进行解码，支持多选，包含：
 - URL解码
 - HTML解码
 - BASE64解码
 - 去除注释  
   去除匹配内容中 `/*` 和 `*/` 以及它们之间的字符
 - 空格压缩  
   将多个空白字符（包括空格）压缩成单个空格字符

来源IP不能进行参数解码，若选择了则会被忽略。

## 规则示例
1. 如 `example.com` 域名有2条UWAF规则：
  * 规则1，请求路径包含 `.php` ，则进行拦截
  * 规则2，源IP包含 `192.168.1.1` ，则放行
  规则1的优先级高于规则2(顺序排列)。

  当客户端的IP为192.168.1.1时，去请求URL为``http://example.com/123.php``的请求，则会触发规则1的拦截策略。
