# CC 规则

CC规则可以对请求进行限流，防止出现大量请求直接回源到源站造成源站网络拥堵或CPU使用率飙升的情况。

## CC防护模式和状态

CC防护模式包括正常模式和紧急模式：

* **正常**：仅自定义规则生效（无自定义规则的话则只有默认规则生效）。
* **紧急**：不仅自定义规则会生效，并且UWAF将根据数据分析、人工智能识别等技术对异常频率的请求进行拦截，但可能存在误杀。紧急模式下UWAF将根据攻击特点进行自动拦截，并且会对请求加入cookie参数进行校验。如果网站存在301跳转，不建议开启紧急模式。

CC状态默认是开启，此时如果用户没有配置CC规则，则会有一条默认规则生效，默认规则为：单个IP 在1分钟内的请求数超过500次则拦截该IP的请求10分钟。**此默认规则在用户没有添加自定义CC规则的情况下强制开启**。如果用户添加任意一条自定义CC规则，则默认规则不生效。**若CC状态为关闭，UWAF将不提供CC防护能力，请谨慎选择**。

对于所有的CC规则，CC防护引擎会统计任何一个请求，但当触发规则后**不会拦截**常见静态类型的文件的访问，具体的文件类型有 `css, ico, png, jpg, js, gif` ，如需开启此类文件的拦截，请联系技术支持人员。

## 自定义CC规则列表

CC规则列表展示了用户添加的自定义规则。在针对某个文件或子目录添加了自定义规则后，出于安全考虑，我们建议您再增加一条兜底的规则，即设置一条单IP在 一段时间内（如60秒）访问 根目录（/）超过 1000次（此值需根据自身业务情况进行设置）的规则，这样可以有效应对攻击者改变攻击路径进行CC攻击的情况。

![cc-rule-img-1](/images/cc_rule_img_1.png)

## 添加规则

![cc-rule-img-3](/images/cc_rule_img_3.png)

### 规则参数说明

|参数|说明|
|-|-|
|规则名称|自定义规则的名称，可以为任意中英文字符|
|限制频率|单IP在统计周期内的访问次数阈值|
|限制特征|请求路径为必选项，且其限制逻辑为完全匹配（等于）或目录匹配（包含）。其他限制字段参照[匹配条件说明](/uewaf/features/rule/UWAF_rule?id=匹配条件说明)。多个限制特征之间的逻辑为且|
|限制方式|对超过限制频率且满足限制特征的IP采取的限制措施，包含以下方式：<br>● 封禁该IP：4层封禁；如前面有CDN等代理，则会封禁建链IP地址，即CDN等代理节点的IP，**导致大面积无法正常访问，请谨慎使用**，默认限制时间2小时，此时间不可更改<br>● 拦截此类请求：7层封禁，UWAF会拒绝封禁的IP的请求并记录HTTP 444状态码；如前面有CDN等代理，需正确配置【真实IP字段设置】，若CDN等代理未正确传递该字段可能存在误封<br>● 启用验证码：重定向到验证码页面，如果用户验证通过，则会把该IP放白10分钟（不进行CC规则判断，其他规则判断不受影响）<br>● 限制请求频率：根据规则的限制频率限制请求频率，即会判断请求到达时之前的统计周期这个时间段内的请求数是否超过访问限制数，未超过则不进行限制，超过了就响应HTTP 429状态码。此种方式的限制时间无效，不记录攻击日志，可通过429状态码过滤访问日志以查询触发规则的IP<br>● 只记录日志：仅记录一条CC攻击日志，不采取实质性的限制措施|
|限制时间|规则的生效时间，超过后会对IP重新进行CC规则判断|


## CC封堵IP

此处可以看到触发了CC规则的IP列表，包含封禁或者触发验证码的IP。【刷新CC黑名单】会将所有IP取消封禁或验证码验证，而操作一栏的【解封该IP】可以将单个IP取消封禁或验证码验证。

![cc-rule-img-2](/images/cc_rule_img_2.png)

## CC规则示例

1. 若某业务域名访问情况一直很稳定，单IP在1分钟内不会超过100次，想使用UWAF抵御潜在的CC攻击。  
  规则示例：
   - 规则名称：防CC规则
   - 限制频率：单IP在60秒访问100次
   - 限制特征：请求路径目录匹配 / （目录匹配加根目录即全站）
   - 限制方式：拦截此类请求
   - 限制时间：1440分钟

   情形：当某恶意客户端在30秒发送了100次请求，则会触发这条CC规则，则此恶意客户端的源IP地址会被封禁24小时，之后24小时内这个IP地址发往这个业务域名请求UWAF都会响应HTTP 444 状态码。


2. 若某在线商城域名将举行一个商品秒杀活动，在预定时段内预计会有大量客户访问，从而引起访问量突增，想使用UWAF进行访问限流。  
  - 规则示例(1)：
    - 规则名称：限流规则1
    - 限制频率：单IP在60秒访问20次
    - 限制特征：请求路径 目录匹配 A路径（秒杀商品所属的路径）
    - 限制方式：启用验证码
    - 限制时间：3分钟  
  
  - 规则示例(2)：
    - 规则名称：限流规则2
    - 限制频率：单IP在60秒访问20次
    - 限制特征：请求路径 目录匹配 A路径（秒杀商品所属的路径）
    - 限制方式：限制请求速率
    - 限制时间：120分钟

    情形(1)：对于规则示例(1)，当某客户端在30秒发送了20次请求，则会触发这条CC规则，则该客户端的源IP地址发起的第21次请求，UWAF会将这次请求重定向到验证码界面。若验证通过，之后10分钟内该IP地址的请求不会进行CC规则判断；若验证不通过，则UWAF在限制时间内对于该IP地址发送到这个在线商城的域名的请求会一直重定向到验证码界面。  
    情形(2)：对于规则示例(2)，当某客户端在30秒发送了20次请求，则会触发这条CC规则，则该客户端的源IP地址发起的第21次请求时，UWAF发现这个IP地址在这60秒内已发送了20条请求，于是响应这次请求HTTP 429状态码。若60秒内，UWAF没有收到这个IP地址的请求，此时该客户端可以继续请求这个在线商城，但在60秒内的请求数不能超过20次。
